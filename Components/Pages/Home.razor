@page "/"
@using Azure;
@using Azure.AI.Vision.ImageAnalysis;
@using System;
@using System.IO;
@using System.Threading.Tasks;
@using Azure.AI.OpenAI;
@using OpenAI.Images;
@rendermode InteractiveServer

<PageTitle>Home</PageTitle>

<h1>Computer Vision</h1>

<p>Insert url or type prompt.</p>
<textarea @bind="urlPrompt" rows="5" cols="50" placeholder="Enter url to analyze or prompt to generate image"></textarea>
<br>
<button @onclick="AnalyzeImage">Analyze Image</button>
<button @onclick="GenerateImage">Generate Image</button>

<div class="image-container">
    <img src="@urlPrompt" />
</div>
<br>

<p id="caption">@caption</p>

@inject IConfiguration Configuration
@code
{
    string urlPrompt = "";

    string caption = "";
    void AnalyzeImage()
    {
        var endpoint = Configuration["Vision:endpoint"];
        var key = Configuration["Vision:key"];

       ImageAnalysisClient client = new ImageAnalysisClient(
            new Uri(endpoint),
            new AzureKeyCredential(key));

        ImageAnalysisResult result = client.Analyze(
            new Uri(urlPrompt), 
            VisualFeatures.Caption | VisualFeatures.Read, 
            new ImageAnalysisOptions { GenderNeutralCaption = true});

        Console.WriteLine("Image analysis results:");
        Console.WriteLine(" Caption:");
        caption = result.Caption.Text;
        StateHasChanged();
        Console.WriteLine($"    '{result.Caption.Text}', Confidence {result.Caption.Confidence:F4}");

        Console.WriteLine(" Read:");
        foreach (DetectedTextBlock block in result.Read.Blocks)
            foreach (DetectedTextLine line in block.Lines)
            {
                Console.WriteLine($"    Line: '{line.Text}', Bounding Polygon: [{string.Join(" ", line.BoundingPolygon)}]");
                foreach (DetectedTextWord word in line.Words)
                {
                    Console.WriteLine($"    Word: '{word.Text}', Confidence {word.Confidence.ToString("#.####")}, Bounding Polygon: [{string.Join(" ", word.BoundingPolygon)}]");
                }
            }
    }
    async void GenerateImage()
    {
        var endpoint = Configuration["Generate:endpoint"];
        var key = Configuration["Generate:key"];

        AzureOpenAIClient azureClient = new(
            new Uri(endpoint),
            new AzureKeyCredential(key));

        ImageClient chatClient = azureClient.GetImageClient("dall-e-2");

        var imageGeneration = await chatClient.GenerateImageAsync(urlPrompt,
        new ImageGenerationOptions()
        {
            Size = GeneratedImageSize.W1024xH1024
        });

        // Use the result to display the generated image
        Console.WriteLine("Image generated successfully!");
    

    Console.WriteLine(imageGeneration.Value.ImageUri);
       

    }
}

